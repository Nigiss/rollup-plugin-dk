{"version":3,"file":"rollup-plugin-dk.es.js","sources":["../src/parse.js","../src/transform-tpl.js","../src/index.js"],"sourcesContent":["import fs from 'fs'\n\nconst fileCache = {}\nconst includesReg = /include\\s*\\(\\[([\\s\\S]+)\\]\\)\\s*;?/\n\nfunction nonNullFilter (item) {\n  return !!item\n}\n\nfunction readFile (path) {\n  return fileCache[path] || (fileCache[path] = fs.readFileSync(path, 'utf8'))\n}\n\nfunction isEs6Code (cnt) {\n  return !!cnt.match(/import.*?from/) || !!cnt.match(/export.*?\\{[^}]+\\}/)\n}\n\nfunction hasInclude (cnt) {\n  return includesReg.test(cnt)\n}\n\nfunction needParse (cnt) {\n  // es6 module无需解析\n  // 但是es6 module 和 include 混用时要解析\n  if (isEs6Code(cnt) && !hasInclude(cnt)) {\n    return true\n  }\n\n  return false\n}\n\nfunction parseIncludes (dir, cnt) {\n  const match = cnt.match(includesReg)\n  if (!match) return []\n  return match[1].split(',').map(line => {\n    if (!line.trim()) {\n      return\n    }\n    return line.match(/\\s*['\"]([^'\"]+)['\"]\\s*/)[1]\n  }).filter(nonNullFilter).map(path => dir + path)\n}\n\nfunction parseExports (cnt) {\n  if (needParse(cnt)) {\n    return null\n  }\n\n  // 解析exported语法：/* exported chList__entry */\n  let reg = /\\/\\*\\s+exported\\s+(\\w+)\\s+\\*\\//\n  var exports = (cnt.match(new RegExp(reg, 'g')) || []).map(exported => reg.exec(exported)[1])\n\n  if (exports.length) return exports\n\n  // 没有exported 函数时，将所有的函数都暴露\n  let regStr = '^function\\\\s+(\\\\w+)'\n  let match = cnt.match(new RegExp(regStr, 'mg'))\n\n  // 没有函数\n  if (!match) return null\n\n  return match.map(m => m.match(regStr)[1])\n}\n\nfunction removeIncludes (cnt) {\n  return cnt.replace(/include\\(\\[[\\s\\S]+?\\]\\)\\s*;\\s*/, '')\n}\n\nfunction generateImports (paths) {\n  return paths.map(path => {\n    var exportFns = parseExports(readFile(path))\n    if (!exportFns) return null\n\n    return `import { ${exportFns.join(', ')} } from '${path}';`\n  }).filter(nonNullFilter).join('\\n')\n}\n\nfunction generateExports (fns) {\n  return `export {\\n    ${fns.join(',\\n    ')}\\n}`\n}\n\nexport {\n  readFile,\n  needParse,\n  removeIncludes,\n  parseIncludes,\n  parseExports,\n  generateImports,\n  generateExports\n}\n","/* eslint-disable */\nexport default function (tmpl) {\n  function unescape(code) {\n    return code.replace(/\\\\('|\\\\)/g, \"$1\").replace(/[\\r\\t\\n]/g, \" \");\n  }\n\n  var c = {\n\n    func :       /{{#\\s*([\\w$]+)\\s*(\\([^)]*\\)|)\\s*}}([\\s\\S]*?){{#}}/g,\n    evaluate:    /\\{\\{([\\s\\S]+?(\\}?)+)\\}\\}/g,\n    interpolate: /\\{\\{=([\\s\\S]+?)\\}\\}/g,\n    conditional: /\\{\\{\\?(\\?)?\\s*([\\s\\S]*?)\\s*\\}\\}/g,\n    transclude:  /\\{\\{\\-(\\-)?\\s*([\\s\\S]*?)\\s*\\}\\}/g,\n    iterate:     /\\{\\{~\\s*(?:\\}\\}|([\\s\\S]+?)\\s*\\:\\s*([\\w$]+)\\s*(?:\\:\\s*([\\w$]+))?\\s*\\}\\})/g,\n  };\n  var cse = {\n    start: \"'+(\",\n    end: \")+'\"\n  }, sid = 0, indv;\n\n  // 只替换{{#func()}}{{#}}里面的内容\n  tmpl = tmpl.replace(c.func, function(m, def, args, str) {\n    // 转译特殊字符，在html拼接的时候出现语法错误\n    str = str.replace(/('|\\\\)/g, '\\\\$1')\n    // 干掉所有空白符, 通过连字符解决，保持文件格式\n    //str = str.replace(/(^|\\r|\\n)\\t* +| +\\t*(\\r|\\n|$)/g,\"\")\n    //.replace(/\\r|\\n|\\t/g,\"\")\n    // 拼接方法名\n    str = \"function \" + def + (args || \"()\") + \" {var out='\" + str;\n    // 替换各种标志符\n    str = str\n      .replace(c.interpolate, function(m, code) {\n        return cse.start + unescape(code) + cse.end;\n      })\n      .replace(c.conditional, function(m, elsecase, code) {\n        return elsecase ?\n          (code ? \"';}else if(\" + unescape(code) + \") {out+='\" : \"';}else {out+='\") :\n        (code ? \"';if(\" + unescape(code) + \") {out+='\" : \"';}out+='\");\n      })\n      .replace(c.transclude, function(m, elsecase, code) {\n        function formatCode() {\n          if (!/\\)$/.test(code)) {\n            // {{-page}}, 无argsBody\n            code = code + '(';\n          } else if (/\\(\\s*\\)$/.test(code)) {\n            // {{-bem(page)()}}, 有body, 但是最后一个是空括号\n            code = code.substr(0, code.length - 1);\n          } else {\n            // {{-bem(page)(1)}}, 有body, 也有内容\n            code = code.substr(0, code.length - 1) + ',';\n          }\n          return code;\n        }\n        return elsecase ?\n          \"';return out;})(), (function() {var out='';out+='\":\n                                               (code ? \"';out+=\" + unescape(formatCode()) + \"(function() {var out=''; out+='\" : \"';return out;})());out+='\");\n      })\n                                               .replace(c.iterate, function(m, iterate, vname, iname) {\n                                                 if (!iterate) return \"';} } out+='\";\n                                                 sid+=1; indv=iname || \"i\"+sid; iterate=unescape(iterate);\n                                                 return \"';var arr\"+sid+\"=\"+iterate+\";if(arr\"+sid+\") {var \"+vname+\",\"+indv+\"=-1,l\"+sid+\"=arr\"+sid+\".length-1;while(\"+indv+\"<l\"+sid+\") {\"\n                                                   +vname+\"=arr\"+sid+\"[\"+indv+\"+=1];out+='\";\n                                               })\n      .replace(c.evaluate, function(m, code) {\n        // 因为此处是js, 所以需要将特殊字符转回来\n        return \"';\" + unescape(code) + \"out+='\";\n      })\n      .replace(/(\\s|;|\\}|^|\\{)out\\+='';/g, \"$1\").replace(/\\+''/g, \"\");\n    // 拼接方法结尾\n    str = str + \"';return out;}\";\n    // 把所有字符串链接起来, 并且保持行数不变\n    str = str.replace(/(\\r|\\n|\\r\\n)/g, '\\\\\\n');\n    return str;\n  });\n  return tmpl;\n}\n","import {\n  readFile,\n  needParse,\n  removeIncludes,\n  parseIncludes,\n  parseExports,\n  generateImports,\n  generateExports\n} from './parse'\nimport transform from './transform-tpl'\n\nfunction getCurrDir (path) {\n  return path.replace(/(.*\\/)(.*)/, '$1')\n}\n\nexport default function () {\n  return {\n    name: 'dk',\n    load (id) {\n      let cnt = readFile(Array.isArray(id) ? id[0] : id)\n      if (needParse(cnt)) {\n        return cnt\n      }\n\n      let currDir = getCurrDir(id)\n      let includePaths = parseIncludes(currDir, cnt)\n      let exportedFns = parseExports(cnt)\n      let code = `${generateImports(includePaths)}\\n${removeIncludes(cnt)}\\n${generateExports(exportedFns)}`\n      return transform(code)\n    }\n  }\n}\n"],"names":[],"mappings":"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"}
{"version":3,"file":"rollup-plugin-dk.es.js","sources":["../src/index.js"],"sourcesContent":["import fs from 'fs'\n\nconst fileCache = {}\nconst includesReg = /include\\s*\\(\\[([\\s\\S]+)\\]\\)\\s*;?/\n\nfunction nonNullFilter (item) {\n  return !!item\n}\n\nfunction readFile (path) {\n  return fileCache[path] || (fileCache[path] = fs.readFileSync(path, 'utf8'))\n}\n\nfunction isEs6Code (cnt) {\n  return !!cnt.match(/import.*?from/) || !!cnt.match(/export.*?\\{[^}]+\\}/)\n}\n\nfunction hasInclude (cnt) {\n  return includesReg.test(cnt)\n}\n\nfunction needParse (cnt) {\n  // es6 module无需解析\n  // 但是es6 module 和 include 混用时要解析\n  if (isEs6Code(cnt) && !hasInclude(cnt)) {\n    return true\n  }\n\n  return false\n}\n\nfunction getCurrDir (path) {\n  return path.replace(/(.*\\/)(.*)/, '$1')\n}\n\nfunction parseIncludes (dir, cnt) {\n  const match = cnt.match(includesReg)\n  if (!match) return []\n  return match[1].split(',').map(line => {\n    if (!line.trim()) {\n      return\n    }\n    return line.match(/\\s*['\"]([^'\"]+)['\"]\\s*/)[1]\n  }).filter(nonNullFilter).map(path => dir + path)\n}\n\nfunction parseExports (cnt) {\n  if (needParse(cnt)) {\n    return null\n  }\n\n  // 解析exported语法：/* exported chList__entry */\n  let reg = /\\/\\*\\s+exported\\s+(\\w+)\\s+\\*\\//\n  var exports = (cnt.match(new RegExp(reg, 'g')) || []).map(exported => reg.exec(exported)[1])\n\n  if (exports.length) return exports\n\n  // 没有exported 函数时，将所有的函数都暴露\n  let regStr = '^function\\\\s+(\\\\w+)'\n  let match = cnt.match(new RegExp(regStr, 'mg'))\n\n  // 没有函数\n  if (!match) return null\n\n  return match.map(m => m.match(regStr)[1])\n}\n\nfunction removeIncludes (cnt) {\n  return cnt.replace(/include\\(\\[[\\s\\S]+?\\]\\)\\s*;\\s*/, '')\n}\n\nfunction generateImports (paths) {\n  return paths.map(path => {\n    var exportFns = parseExports(readFile(path))\n    if (!exportFns) return null\n\n    return `import { ${exportFns.join(', ')} } from '${path}';`\n  }).filter(nonNullFilter).join('\\n')\n}\n\nfunction generateExports (fns) {\n  return `export {\\n    ${fns.join(',\\n    ')}\\n}`\n}\n\nfunction load (id) {\n  let cnt = readFile(Array.isArray(id) ? id[0] : id)\n  if (needParse(cnt)) {\n    return cnt\n  }\n\n  let currDir = getCurrDir(id)\n  let includePaths = parseIncludes(currDir, cnt)\n  let exportedFns = parseExports(cnt)\n\n  return `${generateImports(includePaths)}\\n${removeIncludes(cnt)}\\n${generateExports(exportedFns)}`\n}\n\nexport default function () {\n  return {\n    name: 'dk',\n    load\n  }\n}\n"],"names":[],"mappings":"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"}